databaseChangeLog:
  - changeSet:
      id: create-count-free-places-trigger
      author: SofiaPalkina
      changes:
        - sql:
            splitStatements: false
            stripComments: true
            sql: |
              CREATE OR REPLACE FUNCTION update_parking_free()
              RETURNS trigger AS $$
                BEGIN
                  -- Обновляем значение поля parking_free в таблице parkings
                  UPDATE parkings
                  SET parking_free = (SELECT COUNT(*) FROM places WHERE parking_id = NEW.parking_id AND is_occupied = TRUE)
                  WHERE id = NEW.parking_id;
                  RETURN NEW;
                END;
              $$ LANGUAGE plpgsql;

              CREATE TRIGGER update_parking_free_trigger
                AFTER INSERT OR UPDATE OR DELETE ON places
                FOR EACH ROW
                EXECUTE FUNCTION update_parking_free();