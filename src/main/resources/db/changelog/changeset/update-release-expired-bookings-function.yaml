databaseChangeLog:
  - changeSet:
      id: update-release-expired-bookings-function
      author: SofiaPalkina
      changes:
        - sql:
            dbms: postgresql
            splitStatements: false
            stripComments: false
            sql: |
              DROP FUNCTION IF EXISTS release_expired_bookings;
              
              CREATE OR REPLACE FUNCTION public.release_expired_bookings()
              RETURNS void AS $$
              BEGIN
                UPDATE places
                SET user_id = NULL
                WHERE (parking_id, place_number) IN (
                  SELECT parking_id, place_number
                  FROM booking_logs
                  WHERE released_at <= NOW()
                );
              END;
              $$ LANGUAGE plpgsql;